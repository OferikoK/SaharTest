<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>ğŸ† ××‘×—×Ÿ ××—×•× × ×™× - ××¢×§×‘ ×ª×¨×’×•×œ</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Rubik:wght@400;600;700;900&display=swap');

  :root {
    --bs-dark: #1a0a2e;
    --bs-purple: #2d1b69;
    --bs-blue: #1e3a5f;
    --bs-yellow: #ffd700;
    --bs-orange: #ff8c00;
    --bs-red: #ff3b3b;
    --bs-green: #00e676;
    --bs-cyan: #00e5ff;
    --bs-pink: #ff4081;
    --bs-glow: rgba(255, 215, 0, 0.4);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

  body {
    font-family: 'Rubik', sans-serif;
    background: linear-gradient(135deg, var(--bs-dark) 0%, #0d0221 50%, #1a0533 100%);
    min-height: 100vh;
    color: #fff;
    overflow-x: hidden;
  }

  .stars {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    pointer-events: none; z-index: 0;
    background: radial-gradient(2px 2px at 20% 30%, #fff3, transparent),
                radial-gradient(2px 2px at 40% 70%, #fff2, transparent),
                radial-gradient(1px 1px at 60% 20%, #fff4, transparent),
                radial-gradient(1px 1px at 80% 50%, #fff3, transparent),
                radial-gradient(2px 2px at 10% 80%, #fff2, transparent),
                radial-gradient(1px 1px at 90% 10%, #fff3, transparent),
                radial-gradient(2px 2px at 50% 50%, #fff1, transparent),
                radial-gradient(1px 1px at 30% 90%, #fff2, transparent);
    animation: twinkle 4s ease-in-out infinite alternate;
  }
  @keyframes twinkle { from { opacity: 0.5; } to { opacity: 1; } }

  .app { position: relative; z-index: 1; max-width: 500px; margin: 0 auto; padding: 16px; padding-bottom: 100px; }

  /* Header */
  .header {
    text-align: center; padding: 20px 10px; margin-bottom: 16px;
    background: linear-gradient(180deg, rgba(45,27,105,0.8), rgba(30,58,95,0.6));
    border-radius: 20px; border: 2px solid rgba(255,215,0,0.3);
    box-shadow: 0 0 30px rgba(255,215,0,0.1);
    position: relative;
  }
  .header h1 {
    font-size: 1.6em; font-weight: 900;
    background: linear-gradient(180deg, var(--bs-yellow), var(--bs-orange));
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5)); margin-bottom: 4px;
  }
  .header .subtitle { font-size: 0.85em; color: var(--bs-cyan); font-weight: 600; }
  .admin-toggle {
    position: absolute; top: 10px; left: 10px;
    background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);
    border-radius: 8px; padding: 4px 8px; font-size: 0.7em; color: #888;
    cursor: pointer; font-family: 'Rubik', sans-serif;
  }
  .admin-toggle:active { background: rgba(255,255,255,0.2); }

  /* Character avatar */
  .avatar-section { text-align: center; margin-bottom: 12px; }
  .avatar {
    width: 80px; height: 80px; margin: 0 auto 6px;
    border-radius: 50%; border: 3px solid var(--bs-yellow);
    box-shadow: 0 0 20px var(--bs-glow);
    display: flex; align-items: center; justify-content: center;
    font-size: 3em;
    background: linear-gradient(180deg, rgba(45,27,105,0.9), rgba(30,58,95,0.9));
    animation: avatarPulse 2s ease-in-out infinite;
  }
  @keyframes avatarPulse {
    0%, 100% { box-shadow: 0 0 20px var(--bs-glow); }
    50% { box-shadow: 0 0 35px var(--bs-glow), 0 0 60px rgba(255,215,0,0.15); }
  }
  .player-name { font-size: 0.9em; font-weight: 700; color: var(--bs-yellow); }
  .player-rank { font-size: 0.7em; color: var(--bs-cyan); margin-top: 2px; }

  /* Stats Bar */
  .stats-bar { display: flex; justify-content: space-around; gap: 8px; margin-bottom: 16px; }
  .stat-box {
    flex: 1; background: linear-gradient(180deg, rgba(45,27,105,0.9), rgba(26,10,46,0.9));
    border-radius: 16px; padding: 12px 8px; text-align: center;
    border: 2px solid rgba(255,215,0,0.2); box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    transition: transform 0.3s, box-shadow 0.3s;
  }
  .stat-box:active { transform: scale(0.95); }
  .stat-box .stat-icon { font-size: 1.5em; margin-bottom: 4px; }
  .stat-box .stat-value {
    font-size: 1.4em; font-weight: 900;
    background: linear-gradient(180deg, #fff, var(--bs-cyan));
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  }
  .stat-box .stat-label { font-size: 0.65em; color: #aaa; margin-top: 2px; }

  /* XP Progress bar */
  .xp-section {
    background: linear-gradient(180deg, rgba(45,27,105,0.8), rgba(30,58,95,0.5));
    border-radius: 16px; padding: 14px 16px; margin-bottom: 16px;
    border: 2px solid rgba(0,229,255,0.2);
  }
  .xp-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
  .xp-label { font-size: 0.8em; font-weight: 700; color: var(--bs-cyan); }
  .xp-value { font-size: 0.8em; font-weight: 700; color: var(--bs-yellow); }
  .xp-bar-bg {
    height: 22px; border-radius: 11px;
    background: rgba(0,0,0,0.5); border: 1px solid rgba(255,215,0,0.2);
    overflow: hidden; position: relative;
  }
  .xp-bar-fill {
    height: 100%; border-radius: 11px;
    background: linear-gradient(90deg, var(--bs-green), var(--bs-cyan), var(--bs-yellow));
    transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 0 15px rgba(0,230,118,0.5); position: relative;
  }
  .xp-bar-fill::after {
    content: ''; position: absolute; top: 0; left: 0; right: 0; height: 50%;
    background: linear-gradient(180deg, rgba(255,255,255,0.35), transparent); border-radius: 11px;
  }
  .xp-bar-text {
    position: absolute; top: 0; left: 0; right: 0; bottom: 0;
    display: flex; align-items: center; justify-content: center;
    font-size: 0.65em; font-weight: 900; color: #fff;
    text-shadow: 0 1px 3px rgba(0,0,0,0.7);
  }
  .xp-next-prize { font-size: 0.7em; color: #aaa; margin-top: 6px; text-align: center; }

  /* Prize showcase */
  .prizes-section {
    background: linear-gradient(180deg, rgba(45,27,105,0.6), rgba(26,10,46,0.6));
    border-radius: 16px; padding: 14px; margin-bottom: 16px;
    border: 2px solid rgba(255,64,129,0.2);
  }
  .prizes-title { font-size: 0.9em; font-weight: 700; color: var(--bs-pink); text-align: center; margin-bottom: 10px; }
  .prizes-list { display: flex; flex-wrap: wrap; gap: 6px; justify-content: center; }
  .prize-chip {
    background: linear-gradient(135deg, rgba(255,64,129,0.2), rgba(255,140,0,0.2));
    border: 1px solid rgba(255,215,0,0.3); border-radius: 12px;
    padding: 6px 10px; font-size: 0.75em; font-weight: 600;
    display: flex; align-items: center; gap: 4px;
    animation: chipGlow 2s ease-in-out infinite alternate;
  }
  @keyframes chipGlow {
    from { box-shadow: 0 0 5px rgba(255,64,129,0.2); }
    to { box-shadow: 0 0 15px rgba(255,64,129,0.4); }
  }
  .prize-chip.claimed { background: linear-gradient(135deg, rgba(0,230,118,0.3), rgba(0,229,255,0.2)); border-color: var(--bs-green); }

  /* Units list */
  .units-title { font-size: 1em; font-weight: 900; color: var(--bs-yellow); margin-bottom: 12px; text-align: center; }
  .unit-card {
    background: linear-gradient(180deg, rgba(45,27,105,0.7), rgba(30,58,95,0.5));
    border-radius: 14px; padding: 14px 16px; margin-bottom: 10px;
    border: 2px solid rgba(255,255,255,0.1);
    display: flex; align-items: center; gap: 12px;
    transition: all 0.3s ease; cursor: pointer;
    -webkit-user-select: none; user-select: none;
    position: relative; overflow: hidden;
  }
  .unit-card::before {
    content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,215,0,0.05), transparent);
    animation: shimmer 3s ease-in-out infinite;
  }
  @keyframes shimmer { 0% { left: -100%; } 50% { left: 100%; } 100% { left: 100%; } }
  .unit-card:active { transform: scale(0.97); }
  .unit-card.done {
    border-color: rgba(0,230,118,0.4);
    background: linear-gradient(180deg, rgba(0,100,50,0.3), rgba(0,60,30,0.3));
  }
  .unit-card.done::before { display: none; }
  .unit-num {
    width: 40px; height: 40px; border-radius: 50%;
    background: linear-gradient(135deg, var(--bs-purple), var(--bs-blue));
    border: 2px solid var(--bs-yellow);
    display: flex; align-items: center; justify-content: center;
    font-weight: 900; font-size: 0.85em; flex-shrink: 0;
    box-shadow: 0 0 10px var(--bs-glow);
  }
  .unit-card.done .unit-num {
    background: linear-gradient(135deg, #004d25, #006633);
    border-color: var(--bs-green); box-shadow: 0 0 10px rgba(0,230,118,0.3);
  }
  .unit-name { flex: 1; font-size: 0.8em; font-weight: 600; line-height: 1.3; }
  .unit-status { font-size: 1.3em; flex-shrink: 0; }
  .unit-pts {
    font-size: 0.65em; font-weight: 700; color: var(--bs-yellow);
    background: rgba(255,215,0,0.15); padding: 3px 10px; border-radius: 8px; flex-shrink: 0;
  }
  .unit-card.done .unit-pts { color: var(--bs-green); background: rgba(0,230,118,0.15); }

  /* Confetti & particles */
  .particle-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1000; }
  .particle { position: absolute; border-radius: 3px; animation: particleFall linear forwards; }
  @keyframes particleFall {
    0% { opacity: 1; transform: translateY(0) rotate(0deg) scale(1); }
    100% { opacity: 0; transform: translateY(100vh) rotate(720deg) scale(0.3); }
  }

  /* Star burst effect */
  .star-burst {
    position: fixed; pointer-events: none; z-index: 1001;
  }
  .star-burst .ray {
    position: absolute; width: 3px; background: var(--bs-yellow);
    border-radius: 2px; transform-origin: bottom center;
    animation: rayBurst 0.8s ease-out forwards;
  }
  @keyframes rayBurst {
    0% { height: 0; opacity: 1; }
    50% { height: 40px; opacity: 1; }
    100% { height: 0; opacity: 0; transform: translateY(-60px); }
  }

  /* Points popup */
  .points-popup {
    position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
    z-index: 2000; text-align: center; pointer-events: none;
    animation: popupAnim 2s ease-out forwards;
  }
  @keyframes popupAnim {
    0% { opacity: 0; transform: translate(-50%, -50%) scale(0.3) rotate(-10deg); }
    15% { opacity: 1; transform: translate(-50%, -50%) scale(1.3) rotate(5deg); }
    30% { transform: translate(-50%, -50%) scale(1) rotate(0deg); }
    80% { opacity: 1; }
    100% { opacity: 0; transform: translate(-50%, -70%) scale(0.8); }
  }
  .points-popup .pts-text {
    font-size: 4em; font-weight: 900;
    background: linear-gradient(180deg, var(--bs-yellow), var(--bs-orange));
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    filter: drop-shadow(0 4px 8px rgba(0,0,0,0.7));
  }
  .points-popup .pts-label {
    font-size: 1.4em; color: #fff; font-weight: 700;
    text-shadow: 0 2px 8px rgba(0,0,0,0.8);
  }
  .points-popup .pts-sub {
    font-size: 0.9em; color: var(--bs-cyan); font-weight: 600;
    margin-top: 4px; text-shadow: 0 2px 8px rgba(0,0,0,0.8);
  }

  /* Modal (prize + confirm) */
  .modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.85); z-index: 3000;
    display: flex; align-items: center; justify-content: center;
    padding: 20px; animation: fadeIn 0.3s ease;
  }
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  .modal-box {
    background: linear-gradient(180deg, #2d1b69, #1a0a2e);
    border-radius: 24px; padding: 30px 24px; text-align: center;
    border: 3px solid var(--bs-yellow);
    box-shadow: 0 0 60px var(--bs-glow), 0 0 120px rgba(255,215,0,0.2);
    max-width: 340px; width: 100%;
    animation: modalPop 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  }
  @keyframes modalPop { 0% { transform: scale(0.5); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
  .modal-box .trophy { font-size: 4em; margin-bottom: 10px; animation: bounce 1s ease infinite; }
  @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
  .modal-box h2 {
    font-size: 1.4em; font-weight: 900;
    background: linear-gradient(180deg, var(--bs-yellow), var(--bs-orange));
    -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 8px;
  }
  .modal-box .prize-reveal { font-size: 1.1em; color: #fff; font-weight: 700; margin-bottom: 6px; }
  .modal-box .prize-name {
    font-size: 1.5em; font-weight: 900; color: var(--bs-cyan);
    margin-bottom: 16px; text-shadow: 0 0 20px rgba(0,229,255,0.5);
  }
  .modal-box .prize-icon { font-size: 3em; margin-bottom: 16px; }
  .modal-box .confirm-text { font-size: 1em; color: #ccc; margin-bottom: 16px; line-height: 1.5; }
  .modal-box .confirm-unit { font-size: 0.9em; color: var(--bs-cyan); font-weight: 700; margin-bottom: 16px; }
  .modal-btn {
    background: linear-gradient(180deg, var(--bs-yellow), var(--bs-orange));
    color: #1a0a2e; border: none; border-radius: 14px;
    padding: 12px 32px; font-family: 'Rubik', sans-serif;
    font-size: 1em; font-weight: 900; cursor: pointer;
    box-shadow: 0 4px 15px rgba(255,215,0,0.4); transition: transform 0.2s;
    margin: 4px;
  }
  .modal-btn:active { transform: scale(0.95); }
  .modal-btn.cancel {
    background: linear-gradient(180deg, #444, #333); color: #ccc;
    box-shadow: none;
  }
  .modal-btn.danger {
    background: linear-gradient(180deg, var(--bs-red), #cc0000); color: #fff;
    box-shadow: 0 4px 15px rgba(255,59,59,0.3);
  }

  /* Admin panel */
  .admin-panel {
    background: linear-gradient(180deg, rgba(100,20,20,0.8), rgba(60,10,10,0.9));
    border-radius: 16px; padding: 16px; margin-bottom: 16px;
    border: 2px solid rgba(255,59,59,0.4);
  }
  .admin-title { font-size: 0.9em; font-weight: 700; color: var(--bs-red); text-align: center; margin-bottom: 12px; }
  .admin-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; gap: 8px; }
  .admin-label { font-size: 0.75em; color: #ccc; flex: 1; }
  .admin-btn {
    background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);
    border-radius: 8px; padding: 6px 12px; font-family: 'Rubik', sans-serif;
    font-size: 0.7em; font-weight: 600; color: #fff; cursor: pointer;
    min-width: 36px; text-align: center;
  }
  .admin-btn:active { background: rgba(255,255,255,0.25); }
  .admin-btn.red { border-color: rgba(255,59,59,0.5); color: var(--bs-red); }
  .admin-btn.green { border-color: rgba(0,230,118,0.5); color: var(--bs-green); }
  .admin-pts-display {
    font-size: 0.85em; font-weight: 900; color: var(--bs-yellow);
    min-width: 40px; text-align: center;
  }

  /* Streak badge */
  .streak-badge {
    display: inline-flex; align-items: center; gap: 4px;
    background: linear-gradient(135deg, rgba(255,140,0,0.3), rgba(255,59,59,0.2));
    border: 1px solid rgba(255,140,0,0.4); border-radius: 10px;
    padding: 3px 10px; font-size: 0.7em; font-weight: 700; color: var(--bs-orange);
    margin-top: 6px;
  }

  /* Completion celebration */
  .all-done {
    text-align: center; padding: 30px; margin: 20px 0;
    background: linear-gradient(180deg, rgba(0,100,50,0.3), rgba(0,60,30,0.3));
    border-radius: 20px; border: 2px solid var(--bs-green);
    box-shadow: 0 0 40px rgba(0,230,118,0.2);
  }
  .all-done .big-trophy { font-size: 4em; animation: bounce 1s ease infinite; }
  .all-done h2 { font-size: 1.5em; color: var(--bs-green); margin: 10px 0; }
  .all-done p { color: #aaa; font-size: 0.85em; }

  /* Reset */
  .reset-section { text-align: center; margin-top: 30px; padding-bottom: 20px; }
  .reset-btn {
    background: rgba(255,59,59,0.2); color: var(--bs-red);
    border: 1px solid rgba(255,59,59,0.3); border-radius: 10px;
    padding: 8px 20px; font-family: 'Rubik', sans-serif;
    font-size: 0.75em; font-weight: 600; cursor: pointer;
  }
</style>
</head>
<body>

<div class="stars"></div>
<div class="particle-container" id="particles"></div>
<div class="app" id="app"></div>

<script>
const ALL_UNITS = [
  "×‘×¢×™×•×ª ××™×œ×•×œ×™×•×ª ×‘×œ×‘×“",
  "×”×‘× ×ª ×”× ×§×¨× ×•×™×“×¢ ×›×œ×œ×™ ×‘×œ×‘×“",
  "××‘×—×Ÿ ×œ×“×•×’×× ×™×•× ×",
  "××‘×—×Ÿ ×œ×“×•×’×× ×™×•× ×’",
  "××‘×—×Ÿ ×œ×“×•×’×× ×™×•× ×“",
  "××‘×—×Ÿ ×œ×“×•×’×× ×™×•× ×”",
  "××‘×—×Ÿ ×œ×“×•×’×× ×™×•× ×•",
  "××‘×—×Ÿ ××—×•× × ×™× ×©×œ ×§×œ××•×“ 3",
  "××‘×—×Ÿ ××—×•× × ×™× ×©×œ ×§×œ××•×“ 4",
  "××‘×—×Ÿ ××—×•× × ×™× ×©×œ ×§×œ××•×“ 5",
  "××‘×—×Ÿ ××—×•× × ×™× ×©×œ ×§×œ××•×“ 6",
  "××‘×—×Ÿ ××—×•× × ×™× ×©×œ ×§×œ××•×“ 7",
  "××‘×—×Ÿ ××œ× ×œ×“×•×’×× ×™×•× ×‘",
  "××‘×—×Ÿ ××œ× ×œ×“×•×’×× ×™×•× ×“",
  "××‘×—×Ÿ ××œ× ×œ×“×•×’×× ×§×œ××•×“ ×™×•× ×•",
  "××‘×—×Ÿ ××œ× ×œ×“×•×’×× ×§×œ××•×“ ×™×•× ×—",
  "×§×©×¨×™× ××™×œ×•×œ×™×™× ×‘×œ×‘×“",
  "×ª×¨×’×•×œ ×¨×¦×¤×™×",
  "×ª×¨×’×™×œ×™ ×¡×“×¨×•×ª ×‘×œ×‘×“"
];

const PRIZES = [
  { name: "×××ª×§", icon: "ğŸ¬" },
  { name: "×¦×¢×¦×•×¢", icon: "ğŸ§¸" },
  { name: "×—×¦×™ ×©×¢×” ××¡×š ×‘×©×‘×ª", icon: "ğŸ“º" },
  { name: "×˜××‘×œ×˜ ×—×¦×™ ×©×¢×” ×‘×××¦×¢ ×©×‘×•×¢", icon: "ğŸ“±" },
  { name: '15 ×©"×— ×œ×§××©×§××©', icon: "ğŸ’°" }
];

const ENCOURAGEMENTS = [
  "!××œ×•×£", "!××“×”×™×", "!×›×œ ×”×›×‘×•×“", "!×™××œ×œ×”, ×§×“×™××”", "!×‘×•×œ ×¤×’×™×¢×”",
  "!××©", "!××›×•× ×”", "!×—×–×§", "!×¡×•×¤×¨ ×¡×˜××¨", "!×‘×•×"
];

const RANK_NAMES = [
  { min: 0, name: "×˜×™×¨×•×Ÿ", icon: "ğŸ¥‰" },
  { min: 30, name: "×œ×•×—×", icon: "ğŸ¥ˆ" },
  { min: 70, name: "××¤×§×“", icon: "ğŸ¥‡" },
  { min: 120, name: "××œ×•×£", icon: "ğŸ‘‘" },
  { min: 190, name: "××’×“×”!", icon: "âš¡" }
];

const PTS_PER_UNIT = 10;
const PTS_PER_PRIZE = 50;
let showAdmin = false;

// ============ STATE ============
function loadState() {
  try {
    const saved = localStorage.getItem('gifted_tracker');
    if (saved) return JSON.parse(saved);
  } catch(e) {}
  try {
    const el = document.getElementById('saved-state');
    if (el) return JSON.parse(el.textContent);
  } catch(e) {}
  return { completed: [], prizes: [], lastAction: null, bonusPts: 0, completedDates: {} };
}

let state = loadState();
if (!state.bonusPts) state.bonusPts = 0;
if (!state.completedDates) state.completedDates = {};

function saveState() {
  try { localStorage.setItem('gifted_tracker', JSON.stringify(state)); } catch(e) {}
}

function getTotalPts() {
  return state.completed.length * PTS_PER_UNIT + (state.bonusPts || 0);
}

function getRank(pts) {
  let rank = RANK_NAMES[0];
  for (const r of RANK_NAMES) { if (pts >= r.min) rank = r; }
  return rank;
}

function getStreak() {
  const dates = Object.values(state.completedDates || {});
  if (dates.length === 0) return 0;
  const unique = [...new Set(dates)].sort().reverse();
  const today = new Date().toISOString().slice(0, 10);
  const yesterday = new Date(Date.now() - 86400000).toISOString().slice(0, 10);
  if (unique[0] !== today && unique[0] !== yesterday) return 0;
  let streak = 1;
  for (let i = 1; i < unique.length; i++) {
    const d1 = new Date(unique[i - 1]);
    const d2 = new Date(unique[i]);
    const diff = (d1 - d2) / 86400000;
    if (diff === 1) streak++;
    else break;
  }
  return streak;
}

// ============ RENDER ============
function render() {
  const app = document.getElementById('app');
  const totalPts = getTotalPts();
  const totalPrizes = Math.floor(totalPts / PTS_PER_PRIZE);
  const ptsInCycle = totalPts % PTS_PER_PRIZE;
  const ptsToNext = PTS_PER_PRIZE - ptsInCycle;
  const xpProgress = (ptsInCycle / PTS_PER_PRIZE) * 100;
  const remaining = ALL_UNITS.length - state.completed.length;
  const rank = getRank(totalPts);
  const streak = getStreak();

  let html = `
    <div class="header">
      <button class="admin-toggle" onclick="showAdmin=!showAdmin; render();">âš™ï¸</button>
      <h1>âš”ï¸ ××‘×—×Ÿ ××—×•× × ×™× âš”ï¸</h1>
      <div class="subtitle">××¦×‘ ×§×¨×‘!</div>
    </div>

    <div class="avatar-section">
      <div class="avatar">${rank.icon}</div>
      <div class="player-name">×¡×”×¨</div>
      <div class="player-rank">×“×¨×’×”: ${rank.name}</div>
      ${streak >= 2 ? `<div class="streak-badge">ğŸ”¥ ×¨×¦×£ ${streak} ×™××™×!</div>` : ''}
    </div>

    <div class="stats-bar">
      <div class="stat-box">
        <div class="stat-icon">â­</div>
        <div class="stat-value">${totalPts}</div>
        <div class="stat-label">× ×§×•×“×•×ª</div>
      </div>
      <div class="stat-box">
        <div class="stat-icon">ğŸ†</div>
        <div class="stat-value">${totalPrizes}</div>
        <div class="stat-label">×¤×¨×¡×™×</div>
      </div>
      <div class="stat-box">
        <div class="stat-icon">ğŸ“‹</div>
        <div class="stat-value">${state.completed.length}/${ALL_UNITS.length}</div>
        <div class="stat-label">×”×•×©×œ××•</div>
      </div>
    </div>

    <div class="xp-section">
      <div class="xp-header">
        <span class="xp-label">ğŸ”¥ ×”×ª×§×“××•×ª ×œ×¤×¨×¡ ×”×‘×</span>
        <span class="xp-value">${ptsInCycle}/${PTS_PER_PRIZE}</span>
      </div>
      <div class="xp-bar-bg">
        <div class="xp-bar-fill" style="width:${xpProgress}%"></div>
        <div class="xp-bar-text">${ptsInCycle}/${PTS_PER_PRIZE}</div>
      </div>
      <div class="xp-next-prize">${remaining > 0 ? `×¢×•×“ ${ptsToNext} × ×§×•×“×•×ª ×œ×¤×¨×¡!` : ''}</div>
    </div>
  `;

  // Admin panel
  if (showAdmin) {
    html += `
    <div class="admin-panel">
      <div class="admin-title">âš™ï¸ × ×™×”×•×œ (×”×•×¨×™×)</div>
      <div class="admin-row">
        <div class="admin-label">× ×§×•×“×•×ª ×‘×•× ×•×¡:</div>
        <button class="admin-btn red" onclick="adjustBonus(-10)">-10</button>
        <div class="admin-pts-display">${state.bonusPts || 0}</div>
        <button class="admin-btn green" onclick="adjustBonus(+10)">+10</button>
      </div>
      <div class="admin-row">
        <div class="admin-label">××™×¤×•×¡ × ×§×•×“×•×ª ×‘×•× ×•×¡:</div>
        <button class="admin-btn red" onclick="resetBonus()">××™×¤×•×¡</button>
      </div>
      <div class="admin-row">
        <div class="admin-label">×‘×™×˜×•×œ ×™×—×™×“×” ××—×¨×•× ×”:</div>
        <button class="admin-btn" onclick="undoLast()" ${!state.lastAction ? 'style="opacity:0.4"' : ''}>â†©ï¸ ×‘×˜×œ</button>
      </div>
      <div class="admin-row">
        <div class="admin-label">××™×¤×•×¡ ×”×›×œ:</div>
        <button class="admin-btn red" onclick="resetAll()">ğŸ—‘ï¸ ××—×§ ×”×›×œ</button>
      </div>
    </div>`;
  }

  // Prizes section
  if (state.prizes.length > 0) {
    html += `<div class="prizes-section"><div class="prizes-title">ğŸ ×”×¤×¨×¡×™× ×©×œ×š (${state.prizes.length})</div><div class="prizes-list">`;
    state.prizes.forEach(p => {
      html += `<div class="prize-chip claimed">${p.icon} ${p.name}</div>`;
    });
    html += `</div></div>`;
  }

  // All done celebration
  if (remaining === 0) {
    html += `
    <div class="all-done">
      <div class="big-trophy">ğŸ†</div>
      <h2>×¡×™×™××ª ×”×›×œ!!!</h2>
      <p>××ª×” ××œ×•×£ ×××™×ª×™! ×›×œ ${ALL_UNITS.length} ×”×™×—×™×“×•×ª ×”×•×©×œ××•!</p>
    </div>`;
  }

  // Remaining units
  const remaining_units = ALL_UNITS.filter(u => !state.completed.includes(u));
  if (remaining_units.length > 0) {
    html += `<div class="units-title">âš¡ ×™×—×™×“×•×ª ×œ×ª×¨×’×•×œ (${remaining_units.length})</div>`;
    remaining_units.forEach((unit) => {
      const globalIdx = ALL_UNITS.indexOf(unit) + 1;
      const escaped = unit.replace(/'/g, "\\'").replace(/"/g, '&quot;');
      html += `
        <div class="unit-card" onclick="confirmComplete('${escaped}')">
          <div class="unit-num">${globalIdx}</div>
          <div class="unit-name">${unit}</div>
          <div class="unit-pts">+${PTS_PER_UNIT}</div>
          <div class="unit-status">ğŸ‘Š</div>
        </div>`;
    });
  }

  // Completed units
  if (state.completed.length > 0) {
    html += `<div class="units-title" style="margin-top:20px">âœ… ×¡×™×™×× ×•! (${state.completed.length})</div>`;
    state.completed.slice().reverse().forEach((unit) => {
      const date = state.completedDates[unit] || '';
      html += `
        <div class="unit-card done">
          <div class="unit-num">âœ“</div>
          <div class="unit-name">${unit}${date ? '<br><span style="font-size:0.7em;color:#888;">' + date + '</span>' : ''}</div>
          <div class="unit-pts">+${PTS_PER_UNIT} âœ”</div>
          <div class="unit-status">ğŸŒŸ</div>
        </div>`;
    });
  }

  app.innerHTML = html;
}

// ============ CONFIRM DIALOG ============
function confirmComplete(unitName) {
  if (state.completed.includes(unitName)) return;

  const overlay = document.createElement('div');
  overlay.className = 'modal-overlay';
  overlay.innerHTML = `
    <div class="modal-box">
      <div class="trophy">ğŸ¯</div>
      <h2>×¡×™×™××ª ××ª ×”××©×™××”?</h2>
      <div class="confirm-unit">${unitName}</div>
      <div class="confirm-text">×‘×˜×•×— ×©×¢×‘×¨×ª ×¢×œ ×”×›×œ?<br>×× ×›×Ÿ â€” ××’×™×¢ ×œ×š × ×§×•×“×•×ª!</div>
      <div>
        <button class="modal-btn" onclick="this.closest('.modal-overlay').remove(); doComplete('${unitName.replace(/'/g, "\\'")}')">!×¡×™×™××ª×™ ğŸ’ª</button>
        <button class="modal-btn cancel" onclick="this.closest('.modal-overlay').remove()">×¢×•×“ ×œ×</button>
      </div>
    </div>
  `;
  document.body.appendChild(overlay);
}

// ============ ACTIONS ============
function doComplete(unitName) {
  if (state.completed.includes(unitName)) return;

  state.completed.push(unitName);
  state.completedDates[unitName] = new Date().toISOString().slice(0, 10);
  state.lastAction = { type: 'complete', unit: unitName };
  saveState();

  // Effects
  const enc = ENCOURAGEMENTS[Math.floor(Math.random() * ENCOURAGEMENTS.length)];
  showPointsPopup(enc);
  spawnConfetti();
  vibrate();

  const totalPts = getTotalPts();
  const earnedPrizes = Math.floor(totalPts / PTS_PER_PRIZE);

  if (earnedPrizes > state.prizes.length) {
    setTimeout(() => {
      const available = PRIZES.filter(p => !state.prizes.some(sp => sp.name === p.name));
      let prize;
      if (available.length > 0) {
        prize = available[Math.floor(Math.random() * available.length)];
      } else {
        prize = PRIZES[Math.floor(Math.random() * PRIZES.length)];
      }
      state.prizes.push(prize);
      saveState();
      showPrizeModal(prize);
    }, 2000);
  }

  // Server file move (silent fail if no server)
  fetch('/api/complete', {
    method: 'POST', headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({unit: unitName})
  }).catch(() => {});

  setTimeout(() => render(), 400);
}

function adjustBonus(amount) {
  state.bonusPts = Math.max(0, (state.bonusPts || 0) + amount);
  saveState();

  // Check prize changes
  const totalPts = getTotalPts();
  const expectedPrizes = Math.floor(totalPts / PTS_PER_PRIZE);
  while (state.prizes.length > expectedPrizes) state.prizes.pop();
  saveState();

  render();
}

function resetBonus() {
  state.bonusPts = 0;
  const totalPts = getTotalPts();
  const expectedPrizes = Math.floor(totalPts / PTS_PER_PRIZE);
  while (state.prizes.length > expectedPrizes) state.prizes.pop();
  saveState();
  render();
}

function undoLast() {
  if (!state.lastAction) return;
  const action = state.lastAction;
  if (action.type === 'complete') {
    fetch('/api/undo', {
      method: 'POST', headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({unit: action.unit})
    }).catch(() => {});

    state.completed = state.completed.filter(u => u !== action.unit);
    delete state.completedDates[action.unit];
    const totalPts = getTotalPts();
    const expectedPrizes = Math.floor(totalPts / PTS_PER_PRIZE);
    while (state.prizes.length > expectedPrizes) state.prizes.pop();
  }
  state.lastAction = null;
  saveState();
  render();
}

function resetAll() {
  showResetConfirm();
}

function showResetConfirm() {
  const overlay = document.createElement('div');
  overlay.className = 'modal-overlay';
  overlay.innerHTML = `
    <div class="modal-box">
      <div class="trophy">âš ï¸</div>
      <h2>×‘×˜×•×— ×œ××—×•×§ ×”×›×œ?</h2>
      <div class="confirm-text">×›×œ ×”× ×§×•×“×•×ª, ×”×¤×¨×¡×™× ×•×”×”×ª×§×“××•×ª ×™×™××—×§×•!<br>××™ ××¤×©×¨ ×œ×‘×˜×œ ××ª ×–×”.</div>
      <div>
        <button class="modal-btn danger" onclick="this.closest('.modal-overlay').remove(); doReset()">×›×Ÿ, ××—×§ ×”×›×œ</button>
        <button class="modal-btn cancel" onclick="this.closest('.modal-overlay').remove()">×‘×™×˜×•×œ</button>
      </div>
    </div>
  `;
  document.body.appendChild(overlay);
}

function doReset() {
  fetch('/api/reset', {method:'POST',headers:{'Content-Type':'application/json'},body:'{}'}).catch(()=>{});
  state = { completed: [], prizes: [], lastAction: null, bonusPts: 0, completedDates: {} };
  saveState();
  render();
}

// ============ EFFECTS ============
function showPointsPopup(message) {
  const popup = document.createElement('div');
  popup.className = 'points-popup';
  popup.innerHTML = `
    <div class="pts-text">+10</div>
    <div class="pts-label">${message || '!× ×§×•×“×•×ª'}</div>
    <div class="pts-sub">â­ ×¡×”"×›: ${getTotalPts()} × ×§×•×“×•×ª</div>
  `;
  document.body.appendChild(popup);
  setTimeout(() => popup.remove(), 2200);
}

function spawnConfetti() {
  const container = document.getElementById('particles');
  const colors = ['#ffd700', '#ff8c00', '#ff3b3b', '#00e676', '#00e5ff', '#ff4081', '#fff', '#9c27b0'];
  for (let i = 0; i < 50; i++) {
    const p = document.createElement('div');
    p.className = 'particle';
    const size = 4 + Math.random() * 10;
    p.style.width = size + 'px';
    p.style.height = size * (0.5 + Math.random() * 0.5) + 'px';
    p.style.background = colors[Math.floor(Math.random() * colors.length)];
    p.style.left = (5 + Math.random() * 90) + '%';
    p.style.top = '-5%';
    p.style.animationDuration = (1.5 + Math.random() * 2.5) + 's';
    p.style.animationDelay = (Math.random() * 0.6) + 's';
    p.style.borderRadius = Math.random() > 0.5 ? '50%' : '2px';
    container.appendChild(p);
    setTimeout(() => p.remove(), 5000);
  }
}

function vibrate() {
  try { navigator.vibrate && navigator.vibrate(100); } catch(e) {}
}

function showPrizeModal(prize) {
  spawnConfetti();
  spawnConfetti();
  vibrate();
  const overlay = document.createElement('div');
  overlay.className = 'modal-overlay';
  overlay.innerHTML = `
    <div class="modal-box">
      <div class="trophy">ğŸ†</div>
      <h2>!!!×›×œ ×”×›×‘×•×“</h2>
      <div class="prize-reveal">×”×’×¢×ª ×œ-${state.prizes.length * PTS_PER_PRIZE} × ×§×•×“×•×ª!</div>
      <div class="prize-icon">${prize.icon}</div>
      <div class="prize-name">${prize.name}</div>
      <button class="modal-btn" onclick="this.closest('.modal-overlay').remove(); render();">!×™××œ×œ×” ğŸ’ª</button>
    </div>
  `;
  document.body.appendChild(overlay);
}

// ============ INIT ============
render();
</script>
</body>
</html>
